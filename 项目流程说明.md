# Morss 项目流程说明

> **相关文档**：如果你想了解如何使用 XPath 自定义规则从任何网页创建订阅源，请参阅 **[XPATH_CUSTOM_FEEDS_CN.md](XPATH_CUSTOM_FEEDS_CN.md)**

## 项目概述

Morss 是一个用于获取完整全文 RSS 订阅源的工具。它的主要功能是从网络上的简化版 RSS 订阅源中提取链接，然后访问这些链接获取完整文章内容，并将完整内容放回 RSS 订阅源中。

## 核心流程

### 1. 数据流转过程

```
用户请求 → FeedFetch (获取订阅源) → FeedGather (填充文章内容) → FeedFormat (格式化输出) → 返回完整订阅源
```

#### 1.1 FeedFetch 阶段（订阅源获取）
- **输入**：RSS 订阅源的 URL
- **处理**：
  - 使用 `crawler.adv_get()` 下载 RSS 订阅源
  - 支持多种订阅源格式：RSS 2.0、Atom、RDF
  - 可以根据自定义规则从 HTML/JSON 页面生成订阅源（通过 `feedify.ini` 配置）
  - 支持缓存机制，避免重复下载
- **输出**：解析后的订阅源对象（包含标题、描述、文章列表等元数据）

#### 1.2 FeedGather 阶段（内容填充）
- **输入**：订阅源对象
- **处理**：
  - 遍历订阅源中的每个文章条目
  - 使用 `crawler.adv_get()` 访问每篇文章的链接
  - 使用 `readabilite` 模块提取文章主要内容（基于内容分析算法）
  - 支持并发获取，但有时间和数量限制（防止过载）
  - 缓存已处理的文章内容
- **输出**：填充了完整内容的订阅源对象

#### 1.3 FeedFormat 阶段（格式化输出）
- **输入**：完整订阅源对象
- **处理**：根据用户选择的格式进行转换
- **输出格式支持**：
  - RSS/Atom XML
  - JSON
  - CSV
  - HTML

### 2. 代码架构

```
morss/
├── __main__.py       # 入口点：检测运行模式（CLI/Web服务器/CGI）
├── morss.py          # 核心逻辑：FeedFetch、FeedGather、FeedFormat
├── crawler.py        # HTTP 请求处理：下载网页内容，处理重定向、缓存等
├── feeds.py          # 订阅源解析：支持多种格式的解析和生成
├── readabilite.py    # 内容提取：从 HTML 页面中提取主要文章内容
├── caching.py        # 缓存系统：支持内存、Redis、磁盘缓存
├── cli.py            # 命令行接口
├── wsgi.py           # Web 服务器接口
└── feedify.ini       # 自定义规则配置：为特定网站定义抓取规则
```

### 3. 数据传输细节

#### 3.1 HTTP 请求处理（crawler.py）
- 使用 Python 标准库 `urllib` 进行 HTTP 请求
- 支持以下特性：
  - 自动处理 gzip 压缩
  - 跟随 HTTP 重定向（301/302）
  - 处理各种字符编码（使用 `chardet` 自动检测）
  - 随机 User-Agent（避免被屏蔽）
  - Cookie 支持
  - HTTP 缓存（ETag、Last-Modified）

#### 3.2 内容提取（readabilite.py）
- 使用启发式算法识别文章主体：
  - 根据 HTML 标签权重评分
  - 排除广告、侧边栏、评论等无关内容
  - 保留有意义的标签（段落、标题、图片等）
  - 计算内容密度来判断主要内容区域

#### 3.3 缓存机制（caching.py）
- 三种缓存后端：
  1. **内存缓存**（默认）：进程内字典，重启后丢失
  2. **Redis 缓存**：需要外部 Redis 服务
  3. **磁盘缓存**：使用 `diskcache` 库，持久化到本地磁盘
- 缓存内容包括：
  - HTTP 响应（避免重复下载）
  - 提取的文章内容
  - 订阅源解析结果

## 外部依赖分析

### 1. 必需的 Python 依赖（本地安装）
这些依赖包会在 Docker 构建或 pip 安装时下载到本地，**不依赖外部服务**：

```python
# 从 setup.py 中提取
install_requires = [
    'lxml',              # XML/HTML 解析
    'bs4',               # BeautifulSoup，HTML 解析辅助
    'python-dateutil',   # 日期时间解析
    'chardet'            # 字符编码检测
]

extras_require = {
    'full': [
        'redis',         # Redis 缓存客户端（可选）
        'diskcache',     # 磁盘缓存（可选）
        'gunicorn',      # 高性能 HTTP 服务器（可选）
        'setproctitle'   # 进程标题设置（可选）
    ]
}
```

### 2. 运行时的网络依赖

#### 2.1 必需访问的外部资源
当 Morss 运行时，它需要访问：
- **目标 RSS 订阅源**：你想要处理的 RSS/Atom 订阅源 URL
- **文章来源网站**：订阅源中文章链接指向的网站

**这些依赖是功能性的，无法避免**，因为 Morss 的核心功能就是从这些网站获取内容。

#### 2.2 不依赖的外部服务
Morss **不依赖**以下任何外部服务：
- ✅ 不需要访问 morss.it 官方服务器
- ✅ 不需要访问任何 API 服务
- ✅ 不需要第三方内容提取服务
- ✅ 不需要云服务或 CDN
- ✅ 不使用外部数据库

### 3. Docker 部署分析

查看 Dockerfile：
```dockerfile
FROM alpine:edge                    # 基础镜像（一次性下载）

ADD . /app                          # 复制源代码到容器

RUN set -ex; \
    apk add --no-cache --virtual .run-deps python3 py3-lxml py3-setproctitle py3-setuptools; \
    apk add --no-cache --virtual .build-deps py3-pip py3-wheel; \
    pip3 install --no-cache-dir /app[full]; \
    apk del .build-deps                # 构建时从包管理器安装依赖

USER 1000:1000
ENTRYPOINT ["/bin/sh", "/app/morss-helper"]
CMD ["run"]
```

**Docker 部署依赖说明**：
- 基础镜像和依赖包在**构建时**从 Alpine 仓库和 PyPI 下载
- 构建完成后，容器运行**完全自包含**，不需要再次下载
- 所有依赖已打包在镜像中

## 本地部署的自主性

### ✅ 完全可以自主运行的情况

1. **所有依赖已在容器/环境中**
   - Docker 镜像构建后包含所有运行时依赖
   - 不需要连接外部服务运行核心功能

2. **缓存机制保障**
   - 使用磁盘缓存可以持久化已获取的内容
   - 重启后缓存依然有效
   - 可以在离线模式下使用缓存的内容（`--cache` 参数）

3. **核心算法本地化**
   - 内容提取算法（readabilite）完全在本地执行
   - RSS 解析在本地完成
   - 不依赖云 API 或第三方服务

### ⚠️ 仍需网络访问的场景

1. **获取新内容**
   - 必须访问目标 RSS 订阅源
   - 必须访问文章来源网站
   - 这是功能需求，无法避免

2. **可能的风险**
   - 如果目标网站关闭，该订阅源将无法更新（但已缓存的内容仍可用）
   - 如果网站更改 HTML 结构，readabilite 可能需要调整规则
   - 如果网站屏蔽你的 IP，可能需要配置代理

### 🔧 增强自主性的建议

1. **使用磁盘缓存**
   ```bash
   docker run -p 8000:8000 -e CACHE=diskcache -v /home/user/morss-cache:/cache morss
   ```

2. **调整缓存策略**
   ```bash
   # 增加缓存大小和保留时间
   -e CACHE_SIZE=10737418240  # 10GB
   -e LIM_ITEM=-1              # 不限制缓存文章数
   ```

3. **离线模式使用已缓存内容**
   ```bash
   morss --cache http://example.com/feed.xml
   ```

4. **定期备份缓存数据**
   - 缓存目录包含所有已提取的文章内容
   - 可以定期备份以防数据丢失

## 总结

### 项目流程图

```
                           ┌─────────────────┐
                           │   用户请求      │
                           │   (RSS URL)     │
                           └────────┬────────┘
                                    │
                           ┌────────▼────────┐
                           │   FeedFetch     │
                           │  (获取订阅源)    │
                           │  - 下载 RSS     │
                           │  - 解析格式     │
                           │  - 检查缓存     │
                           └────────┬────────┘
                                    │
                           ┌────────▼────────┐
                           │   FeedGather    │
                           │  (填充内容)     │
                           │  - 访问链接     │
                           │  - 提取正文     │
                           │  - 缓存内容     │
                           └────────┬────────┘
                                    │
                           ┌────────▼────────┐
                           │   FeedFormat    │
                           │  (格式化输出)   │
                           │  - RSS/JSON     │
                           │  - CSV/HTML     │
                           └────────┬────────┘
                                    │
                           ┌────────▼────────┐
                           │   返回结果      │
                           └─────────────────┘
```

### 关键点

1. **自主性高**：核心功能完全本地化，不依赖第三方 API
2. **需要网络**：必须访问目标 RSS 源和文章网站（这是功能需求）
3. **可持久化**：通过磁盘缓存可以保存已获取的内容
4. **容错性强**：支持离线模式使用缓存
5. **开源自由**：AGPLv3 许可证，可以自由修改和部署

### 依赖风险评估

| 依赖类型 | 风险等级 | 说明 |
|---------|---------|------|
| Python 依赖包 | 低 | 已打包在容器中，除非 PyPI 彻底消失（不太可能） |
| 目标 RSS 源 | 中 | 如果源网站关闭，该源不可用，但不影响其他源 |
| 文章来源网站 | 中 | 网站关闭后无法获取新内容，但缓存的内容仍可用 |
| Morss 官方服务 | 无 | 本地部署完全不依赖官方服务器 |
| 第三方 API | 无 | 不使用任何第三方 API 服务 |

### 最坏情况分析

**如果原作者停止维护且所有相关网站关闭**：
- ✅ 你的本地部署仍然可以运行
- ✅ 已缓存的文章内容仍然可以访问
- ✅ 可以继续处理任何可访问的 RSS 订阅源
- ✅ 代码开源，可以自己维护和修改
- ❌ 无法获取新订阅源的内容（除非目标网站仍然在线）
- ❌ 如果目标网站大幅改版，可能需要调整提取规则

**结论**：本地部署的 Morss 实例**高度自主**，不会因为原项目停止维护而失效。
