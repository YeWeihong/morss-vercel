<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XPath é€‰æ‹©å™¨å·¥å…· - Morss</title>
    <link rel="shortcut icon" type="image/svg+xml" href="/logo.svg" sizes="any" />
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-top: 0;
            text-align: center;
        }
        
        .description {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .input-section {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        
        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-top: 10px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .button-secondary {
            background-color: #2196F3;
        }
        
        .button-secondary:hover {
            background-color: #0b7dda;
        }
        
        .button-danger {
            background-color: #f44336;
        }
        
        .button-danger:hover {
            background-color: #da190b;
        }
        
        .iframe-container {
            margin: 20px 0;
            border: 2px solid #ddd;
            border-radius: 4px;
            position: relative;
            background: white;
        }
        
        .iframe-header {
            background: #f8f8f8;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
            color: #666;
        }
        
        iframe {
            width: 100%;
            height: 600px;
            border: none;
            display: block;
        }
        
        .output-section {
            margin-top: 30px;
        }
        
        .xpath-rule {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid #4CAF50;
        }
        
        .xpath-rule h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }
        
        .xpath-value {
            background: white;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            word-break: break-all;
            border: 1px solid #ddd;
        }
        
        .copy-btn {
            padding: 6px 12px;
            font-size: 12px;
            margin-top: 8px;
        }
        
        .morss-url {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            border-left: 4px solid #2196F3;
        }
        
        .morss-url h3 {
            margin: 0 0 10px 0;
            color: #1976D2;
            font-size: 16px;
        }
        
        .url-value {
            background: white;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            word-break: break-all;
            border: 1px solid #90caf9;
        }
        
        .instructions {
            background: #fff3cd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }
        
        .instructions h3 {
            margin: 0 0 10px 0;
            color: #856404;
            font-size: 16px;
        }
        
        .instructions ol {
            margin: 10px 0 0 0;
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
            color: #856404;
        }
        
        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }
        
        .help-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 4px;
            margin-top: 30px;
        }
        
        .help-section h2 {
            margin-top: 0;
            color: #333;
        }
        
        .help-section p {
            color: #666;
            line-height: 1.6;
        }
        
        .help-section a {
            color: #2196F3;
            text-decoration: none;
        }
        
        .help-section a:hover {
            text-decoration: underline;
        }
        
        .hidden {
            display: none;
        }
        
        .selection-mode {
            background: #4CAF50;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            border-radius: 4px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ XPath é€‰æ‹©å™¨å·¥å…·</h1>
        <p class="description">
            é€šè¿‡å¯è§†åŒ–æ–¹å¼é€‰æ‹©ç½‘é¡µå…ƒç´ ï¼Œè‡ªåŠ¨ç”Ÿæˆ XPath è§„åˆ™ï¼Œè½»æ¾åˆ›å»ºè‡ªå®šä¹‰ RSS è®¢é˜…æº
        </p>
        
        <div class="instructions">
            <h3>ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
            <p><strong>æ–¹å¼ä¸€ï¼šç›´æ¥åŠ è½½ç½‘é¡µï¼ˆæ¨èï¼‰</strong></p>
            <ol>
                <li>åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­è¾“å…¥ä½ æƒ³è¦æŠ“å–çš„ç½‘é¡µ URL</li>
                <li>ç‚¹å‡»"åŠ è½½ç½‘é¡µ"æŒ‰é’®</li>
                <li>æŒ‰ç…§æç¤ºï¼Œä¾æ¬¡ç‚¹å‡»é¡µé¢ä¸Šçš„å…ƒç´ æ¥é€‰æ‹©ï¼š
                    <ul>
                        <li><strong>è®¢é˜…é¡¹ï¼ˆitemsï¼‰</strong>ï¼šæ‰€æœ‰æ–‡ç« /æ¡ç›®çš„å…±åŒçˆ¶å…ƒç´ ï¼ˆå¿…é€‰ï¼‰</li>
                        <li><strong>æ ‡é¢˜ï¼ˆtitleï¼‰</strong>ï¼šæ–‡ç« æ ‡é¢˜çš„ä½ç½®</li>
                        <li><strong>é“¾æ¥ï¼ˆlinkï¼‰</strong>ï¼šæ–‡ç« é“¾æ¥çš„ä½ç½®</li>
                        <li><strong>å†…å®¹ï¼ˆcontentï¼‰</strong>ï¼šæ–‡ç« æ‘˜è¦æˆ–å†…å®¹</li>
                    </ul>
                </li>
                <li>è‡ªåŠ¨ç”Ÿæˆçš„ XPath è§„åˆ™å’Œ Morss URL ä¼šæ˜¾ç¤ºåœ¨ä¸‹æ–¹</li>
            </ol>
            <p><strong>æ–¹å¼äºŒï¼šæ‰‹åŠ¨è¾“å…¥ XPathï¼ˆé€‚ç”¨äº CORS é™åˆ¶çš„ç½‘ç«™ï¼‰</strong></p>
            <ol>
                <li>ç‚¹å‡»"æ‰‹åŠ¨è¾“å…¥ XPath"æŒ‰é’®</li>
                <li>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ç›®æ ‡ç½‘é¡µï¼ŒæŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·</li>
                <li>ä½¿ç”¨å…ƒç´ é€‰æ‹©å™¨é€‰ä¸­é¡µé¢å…ƒç´ ï¼Œå³é”® â†’ å¤åˆ¶ â†’ å¤åˆ¶ XPath</li>
                <li>å°† XPath ç²˜è´´åˆ°å¯¹åº”çš„è¾“å…¥æ¡†ä¸­</li>
                <li>ç³»ç»Ÿä¼šè‡ªåŠ¨ä¼˜åŒ– XPath å¹¶ç”Ÿæˆ Morss URL</li>
            </ol>
        </div>
        
        <div class="alert alert-warning">
            <strong>âš ï¸ æ³¨æ„ï¼š</strong>ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼ˆCORSï¼‰ï¼Œéƒ¨åˆ†ç½‘ç«™å¯èƒ½æ— æ³•åœ¨æ­¤å·¥å…·ä¸­ç›´æ¥åŠ è½½ã€‚
            å¯¹äºè¿™äº›ç½‘ç«™ï¼Œä½ å¯ä»¥ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰æ‰‹åŠ¨è·å– XPathï¼Œç„¶åä½¿ç”¨ä¸‹æ–¹çš„"æ‰‹åŠ¨è¾“å…¥ XPath"åŠŸèƒ½ã€‚
            è¯¦è§<a href="/XPATH_CUSTOM_FEEDS_CN.md" target="_blank">ã€ŠXPath è‡ªå®šä¹‰è§„åˆ™è¯¦è§£ã€‹</a>
        </div>
        
        <div class="input-section">
            <label for="targetUrl">ç›®æ ‡ç½‘é¡µ URLï¼š</label>
            <input type="text" id="targetUrl" placeholder="https://example.com/blog" />
            <button onclick="loadPage()">åŠ è½½ç½‘é¡µ</button>
            <button class="button-secondary" onclick="showManualInput()">âœ‹ æ‰‹åŠ¨è¾“å…¥ XPath</button>
        </div>
        
        <div id="manualInputSection" class="hidden" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px; border: 2px solid #4CAF50;">
            <h2 style="margin-top: 0; color: #4CAF50;">ğŸ“ æ‰‹åŠ¨è¾“å…¥ XPath æ¨¡å¼</h2>
            <div class="alert alert-info" style="margin-bottom: 20px;">
                <strong>ğŸ’¡ ä½¿ç”¨æ–¹æ³•ï¼š</strong>
                <ol style="margin: 10px 0 0 0; padding-left: 20px;">
                    <li>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ç›®æ ‡ç½‘é¡µï¼ŒæŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·</li>
                    <li>ç‚¹å‡»"å…ƒç´ é€‰æ‹©å™¨"ï¼ˆæˆ–æŒ‰ Ctrl+Shift+Cï¼‰</li>
                    <li>ç‚¹å‡»é¡µé¢ä¸Šè¦æŠ“å–çš„å…ƒç´ </li>
                    <li>åœ¨å¼€å‘è€…å·¥å…·ä¸­ï¼Œå³é”®ç‚¹å‡»é«˜äº®çš„ HTML å…ƒç´  â†’ å¤åˆ¶ â†’ å¤åˆ¶ XPath</li>
                    <li>å°†å¤åˆ¶çš„ XPath ç²˜è´´åˆ°ä¸‹é¢å¯¹åº”çš„è¾“å…¥æ¡†ä¸­</li>
                    <li>ç³»ç»Ÿä¼šè‡ªåŠ¨ä¼˜åŒ– XPath å¹¶ç”Ÿæˆ Morss URL</li>
                </ol>
            </div>
            
            <div class="input-section">
                <label for="manualItems">
                    <strong style="color: #d32f2f;">*</strong> è®¢é˜…é¡¹å®¹å™¨ (items) - å¿…å¡«ï¼š
                    <span style="font-size: 12px; color: #666; font-weight: normal;">é€‰æ‹©æ‰€æœ‰æ–‡ç« /æ¡ç›®çš„å…±åŒçˆ¶å…ƒç´ </span>
                </label>
                <textarea id="manualItems" rows="2" placeholder="ä¾‹å¦‚ï¼š/html/body/div[1]/div[2]/div[@class='post']"></textarea>
            </div>
            
            <div class="input-section">
                <label for="manualTitle">
                    æ ‡é¢˜ (item_title) - å¯é€‰ï¼š
                    <span style="font-size: 12px; color: #666; font-weight: normal;">æ–‡ç« æ ‡é¢˜çš„ä½ç½®ï¼ˆç›¸å¯¹äº itemsï¼‰</span>
                </label>
                <textarea id="manualTitle" rows="2" placeholder="ä¾‹å¦‚ï¼š.//h2/a æˆ– ./div[@class='title']"></textarea>
            </div>
            
            <div class="input-section">
                <label for="manualLink">
                    é“¾æ¥ (item_link) - å¯é€‰ï¼š
                    <span style="font-size: 12px; color: #666; font-weight: normal;">æ–‡ç« é“¾æ¥çš„ä½ç½®ï¼ˆç›¸å¯¹äº itemsï¼‰</span>
                </label>
                <textarea id="manualLink" rows="2" placeholder="ä¾‹å¦‚ï¼š.//a/@href æˆ– .//@data-url"></textarea>
            </div>
            
            <div class="input-section">
                <label for="manualContent">
                    å†…å®¹ (item_content) - å¯é€‰ï¼š
                    <span style="font-size: 12px; color: #666; font-weight: normal;">æ–‡ç« æ‘˜è¦æˆ–å†…å®¹ï¼ˆç›¸å¯¹äº itemsï¼‰</span>
                </label>
                <textarea id="manualContent" rows="2" placeholder="ä¾‹å¦‚ï¼š.//div[@class='summary'] æˆ– ./p"></textarea>
            </div>
            
            <div class="input-section">
                <label for="manualTime">
                    æ—¶é—´ (item_time) - å¯é€‰ï¼š
                    <span style="font-size: 12px; color: #666; font-weight: normal;">å‘å¸ƒæ—¶é—´ï¼ˆç›¸å¯¹äº itemsï¼‰</span>
                </label>
                <textarea id="manualTime" rows="2" placeholder="ä¾‹å¦‚ï¼š.//span[@class='date'] æˆ– .//@datetime"></textarea>
            </div>
            
            <button onclick="generateFromManual()">ğŸš€ ç”Ÿæˆ Morss URL</button>
            <button class="button-danger" onclick="closeManualInput()">å–æ¶ˆ</button>
        </div>
        
        <div id="selectionMode" class="selection-mode hidden">
            æ­£åœ¨é€‰æ‹©ï¼š<span id="currentSelection"></span>
        </div>
        
        <div class="iframe-container hidden" id="iframeContainer">
            <div class="iframe-header">
                å·²åŠ è½½é¡µé¢ï¼š<span id="loadedUrl"></span>
                <button class="button-danger" onclick="closeIframe()" style="float: right; padding: 4px 12px; margin: 0;">å…³é—­</button>
            </div>
            <iframe id="targetFrame" sandbox="allow-same-origin allow-scripts"></iframe>
        </div>
        
        <div class="output-section hidden" id="outputSection">
            <h2>ç”Ÿæˆçš„ XPath è§„åˆ™</h2>
            
            <div id="xpathRules"></div>
            
            <div class="morss-url" id="morssUrlSection">
                <h3>ğŸ”— Morss è®¢é˜… URLï¼ˆç‚¹å‡»å¤åˆ¶ï¼‰</h3>
                <div class="url-value" id="morssUrl"></div>
                <button class="copy-btn button-secondary" onclick="copyMorssUrl()">å¤åˆ¶å®Œæ•´ URL</button>
                <button class="copy-btn" onclick="testInNewTab()">åœ¨æ–°æ ‡ç­¾é¡µæµ‹è¯•</button>
            </div>
        </div>
        
        <div class="help-section">
            <h2>ğŸ’¡ æ›´å¤šå¸®åŠ©</h2>
            <p>
                <strong>å…³äº XPath è§„åˆ™ï¼š</strong> XPath æ˜¯ä¸€ç§åœ¨ HTML/XML æ–‡æ¡£ä¸­æŸ¥æ‰¾ä¿¡æ¯çš„è¯­è¨€ã€‚
                æœ¬å·¥å…·ä¼šè‡ªåŠ¨ç”Ÿæˆç®€æ´çš„ XPath è¡¨è¾¾å¼ã€‚
            </p>
            <p>
                <strong>è¯¦ç»†æ–‡æ¡£ï¼š</strong> 
                <a href="/XPATH_CUSTOM_FEEDS_CN.md" target="_blank">ã€ŠMorss è‡ªå®šä¹‰ XPath è§„åˆ™è¯¦è§£ã€‹</a>
            </p>
            <p>
                <strong>ç¤ºä¾‹ç”¨æ³•ï¼š</strong>
                <br>1. CLI æ¨¡å¼ï¼š<code>morss --items="//div[@class='post']" https://example.com</code>
                <br>2. Web æ¨¡å¼ï¼š<code>https://morss.it/:items=%7C%7Cdiv%5B%40class%3D%27post%27%5D/https://example.com</code>
            </p>
            <p>
                <strong>å…¶ä»–åŠŸèƒ½ï¼š</strong> Morss è¿˜æ”¯æŒä» JSON é¡µé¢åˆ›å»ºè®¢é˜…æºã€CSV å¯¼å‡ºã€ç¼“å­˜ç­‰åŠŸèƒ½ã€‚
                æŸ¥çœ‹ <a href="/">ä¸»é¡µ</a> äº†è§£æ›´å¤šã€‚
            </p>
        </div>
    </div>
    
    <script>
        let xpathRules = {
            items: null,
            item_title: null,
            item_link: null,
            item_content: null,
            item_time: null
        };
        
        let currentStep = null;
        let targetUrl = '';
        let selectionSteps = [
            { key: 'items', label: 'è®¢é˜…é¡¹å®¹å™¨ï¼ˆitemsï¼‰', required: true },
            { key: 'item_title', label: 'æ ‡é¢˜ï¼ˆitem_titleï¼‰', required: false },
            { key: 'item_link', label: 'é“¾æ¥ï¼ˆitem_linkï¼‰', required: false },
            { key: 'item_content', label: 'å†…å®¹ï¼ˆitem_contentï¼‰', required: false }
        ];
        let currentStepIndex = 0;
        
        function loadPage() {
            const url = document.getElementById('targetUrl').value.trim();
            if (!url) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ URL');
                return;
            }
            
            // Validate URL
            try {
                new URL(url);
            } catch (e) {
                alert('URL æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¾“å…¥å®Œæ•´çš„ URLï¼ˆåŒ…æ‹¬ http:// æˆ– https://ï¼‰');
                return;
            }
            
            targetUrl = url;
            document.getElementById('loadedUrl').textContent = url;
            document.getElementById('iframeContainer').classList.remove('hidden');
            
            // Try to load the page
            const iframe = document.getElementById('targetFrame');
            iframe.src = url;
            
            iframe.onerror = function() {
                alert('æ— æ³•åŠ è½½æ­¤é¡µé¢ï¼ˆå¯èƒ½ç”±äº CORS é™åˆ¶ï¼‰ã€‚\nè¯·å°è¯•"ä½¿ç”¨ä»£ç†æ¨¡å¼"æˆ–æ‰‹åŠ¨ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·è·å– XPathã€‚');
            };
            
            iframe.onload = function() {
                try {
                    // Test if we can access iframe content
                    const doc = iframe.contentDocument || iframe.contentWindow.document;
                    if (doc) {
                        startSelection();
                    }
                } catch (e) {
                    alert('æ— æ³•è®¿é—®æ­¤é¡µé¢å†…å®¹ï¼ˆCORS é™åˆ¶ï¼‰ã€‚\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. ä½¿ç”¨"ä»£ç†æ¨¡å¼"ï¼ˆæ¨èï¼‰\n2. æ‰‹åŠ¨ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰è·å– XPath\n3. æŸ¥çœ‹æ–‡æ¡£äº†è§£å¦‚ä½•æ‰‹åŠ¨ç¼–å†™ XPath è§„åˆ™');
                    console.error('CORS error:', e);
                }
            };
        }
        
        function useProxyMode() {
            alert('ä»£ç†æ¨¡å¼è¯´æ˜ï¼š\n\nç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼ŒæŸäº›ç½‘ç«™æ— æ³•ç›´æ¥åœ¨æ­¤å·¥å…·ä¸­åŠ è½½ã€‚\n\næ¨èä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š\n\n1. ã€æ¨èã€‘ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰ï¼š\n   - æ‰“å¼€ç›®æ ‡ç½‘é¡µ\n   - æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·\n   - ç‚¹å‡»"å…ƒç´ é€‰æ‹©å™¨"ï¼ˆCtrl+Shift+Cï¼‰\n   - ç‚¹å‡»é¡µé¢å…ƒç´ \n   - å³é”® â†’ å¤åˆ¶ â†’ å¤åˆ¶ XPath\n\n2. ä½¿ç”¨åœ¨çº¿ XPath æµ‹è¯•å·¥å…·\n\n3. æŸ¥çœ‹æ–‡æ¡£ä¸­çš„ç¤ºä¾‹å­¦ä¹  XPath è¯­æ³•\n\nè¯¦ç»†æ•™ç¨‹ï¼š' + window.location.origin + '/XPATH_CUSTOM_FEEDS_CN.md');
        }
        
        function startSelection() {
            currentStepIndex = 0;
            nextStep();
        }
        
        function nextStep() {
            if (currentStepIndex >= selectionSteps.length) {
                finishSelection();
                return;
            }
            
            const step = selectionSteps[currentStepIndex];
            currentStep = step.key;
            
            document.getElementById('selectionMode').classList.remove('hidden');
            document.getElementById('currentSelection').textContent = step.label;
            
            const iframe = document.getElementById('targetFrame');
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            
            // Remove previous event listeners by cloning iframe
            // Actually, let's use a different approach - add overlay
            addSelectionOverlay(doc, step);
        }
        
        function addSelectionOverlay(doc, step) {
            // Remove existing overlay
            const existingOverlay = doc.getElementById('morss-xpath-overlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            
            // Create instruction overlay
            const overlay = doc.createElement('div');
            overlay.id = 'morss-xpath-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px;
                z-index: 999999;
                text-align: center;
                font-family: sans-serif;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            `;
            overlay.innerHTML = `
                <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">
                    è¯·é€‰æ‹©ï¼š${step.label}
                </div>
                <div style="font-size: 14px;">
                    ${step.required ? 'ï¼ˆå¿…é€‰ï¼‰' : 'ï¼ˆå¯é€‰ï¼‰'} 
                    ç‚¹å‡»é¡µé¢ä¸Šå¯¹åº”çš„å…ƒç´ ï¼Œæˆ– 
                    <a href="#" onclick="window.parent.skipStep(); return false;" 
                       style="color: #ffeb3b; text-decoration: underline;">è·³è¿‡æ­¤æ­¥éª¤</a>
                </div>
            `;
            doc.body.insertBefore(overlay, doc.body.firstChild);
            
            // Add click listener to all elements
            doc.body.addEventListener('click', handleElementClick, true);
        }
        
        function handleElementClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const element = e.target;
            
            // Don't select the overlay itself
            if (element.id === 'morss-xpath-overlay' || element.closest('#morss-xpath-overlay')) {
                return;
            }
            
            const xpath = getXPath(element);
            const step = selectionSteps[currentStepIndex];
            
            xpathRules[step.key] = xpath;
            
            // Visual feedback
            element.style.outline = '3px solid #4CAF50';
            setTimeout(() => {
                element.style.outline = '';
            }, 500);
            
            // Move to next step
            currentStepIndex++;
            
            // Remove event listener
            const iframe = document.getElementById('targetFrame');
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            doc.body.removeEventListener('click', handleElementClick, true);
            
            // Remove overlay
            const overlay = doc.getElementById('morss-xpath-overlay');
            if (overlay) {
                overlay.remove();
            }
            
            // Next step or finish
            setTimeout(() => {
                nextStep();
            }, 600);
        }
        
        function skipStep() {
            const step = selectionSteps[currentStepIndex];
            if (step.required) {
                alert('æ­¤æ­¥éª¤ä¸ºå¿…é€‰é¡¹ï¼Œä¸èƒ½è·³è¿‡');
                return;
            }
            
            currentStepIndex++;
            
            // Remove event listener
            const iframe = document.getElementById('targetFrame');
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            doc.body.removeEventListener('click', handleElementClick, true);
            
            // Remove overlay
            const overlay = doc.getElementById('morss-xpath-overlay');
            if (overlay) {
                overlay.remove();
            }
            
            nextStep();
        }
        
        function finishSelection() {
            document.getElementById('selectionMode').classList.add('hidden');
            
            // Remove overlay from iframe
            try {
                const iframe = document.getElementById('targetFrame');
                const doc = iframe.contentDocument || iframe.contentWindow.document;
                const overlay = doc.getElementById('morss-xpath-overlay');
                if (overlay) {
                    overlay.remove();
                }
            } catch (e) {
                console.error('Could not remove overlay:', e);
            }
            
            displayResults();
        }
        
        function getXPath(element) {
            if (element.id !== '') {
                return `//*[@id="${element.id}"]`;
            }
            
            if (element === document.body) {
                return '/html/body';
            }
            
            let ix = 0;
            const siblings = element.parentNode ? element.parentNode.childNodes : [];
            
            for (let i = 0; i < siblings.length; i++) {
                const sibling = siblings[i];
                if (sibling === element) {
                    // Generate a more readable XPath
                    const tagName = element.tagName.toLowerCase();
                    let pathPart = tagName;
                    
                    // Add class information if available
                    if (element.className && typeof element.className === 'string') {
                        const classes = element.className.trim().split(/\s+/);
                        if (classes.length > 0 && classes[0]) {
                            pathPart = `${tagName}[@class="${classes[0]}"]`;
                        }
                    }
                    
                    return getXPath(element.parentNode) + '/' + pathPart;
                }
                
                if (sibling.nodeType === 1 && sibling.tagName === element.tagName) {
                    ix++;
                }
            }
            
            return '';
        }
        
        function displayResults() {
            document.getElementById('outputSection').classList.remove('hidden');
            
            const rulesContainer = document.getElementById('xpathRules');
            rulesContainer.innerHTML = '';
            
            // Show optimization info if items was optimized
            if (xpathRules._original_items) {
                const optimizationDiv = document.createElement('div');
                optimizationDiv.className = 'xpath-rule';
                optimizationDiv.style.borderLeftColor = '#2196F3';
                optimizationDiv.innerHTML = `
                    <h3>âœ¨ XPath è‡ªåŠ¨ä¼˜åŒ–</h3>
                    <div style="margin-bottom: 10px;">
                        <strong>åŸå§‹ XPathï¼š</strong>
                        <div class="xpath-value" style="background: #fff3cd; border-color: #ffc107;">${escapeHtml(xpathRules._original_items)}</div>
                    </div>
                    <div>
                        <strong>ä¼˜åŒ–å XPathï¼š</strong>
                        <div class="xpath-value" style="background: #e8f5e9; border-color: #4CAF50;">${escapeHtml(xpathRules.items)}</div>
                    </div>
                    <p style="color: #666; font-size: 13px; margin-top: 10px; margin-bottom: 0;">
                        ğŸ’¡ ç³»ç»Ÿè‡ªåŠ¨ç®€åŒ–äº† XPathï¼Œä½¿å…¶æ›´é€šç”¨å’Œæ˜“äºç»´æŠ¤ã€‚ä¼˜åŒ–åçš„ XPath å°†ç”¨äºç”Ÿæˆ Morss URLã€‚
                    </p>
                `;
                rulesContainer.appendChild(optimizationDiv);
            }
            
            for (const [key, value] of Object.entries(xpathRules)) {
                if (value && !key.startsWith('_')) {
                    const ruleDiv = document.createElement('div');
                    ruleDiv.className = 'xpath-rule';
                    ruleDiv.innerHTML = `
                        <h3>${getRuleLabel(key)}</h3>
                        <div class="xpath-value">${escapeHtml(value)}</div>
                        <button class="copy-btn" onclick="copyToClipboard('${escapeForJs(value)}')">å¤åˆ¶ XPath</button>
                    `;
                    rulesContainer.appendChild(ruleDiv);
                }
            }
            
            // Generate Morss URL
            generateMorssUrl();
        }
        
        function getRuleLabel(key) {
            const labels = {
                'items': 'è®¢é˜…é¡¹ï¼ˆitemsï¼‰',
                'item_title': 'æ ‡é¢˜ï¼ˆitem_titleï¼‰',
                'item_link': 'é“¾æ¥ï¼ˆitem_linkï¼‰',
                'item_content': 'å†…å®¹ï¼ˆitem_contentï¼‰',
                'item_time': 'æ—¶é—´ï¼ˆitem_timeï¼‰'
            };
            return labels[key] || key;
        }
        
        function generateMorssUrl() {
            if (!xpathRules.items) {
                document.getElementById('morssUrl').textContent = 'é”™è¯¯ï¼šç¼ºå°‘å¿…éœ€çš„ items è§„åˆ™';
                return;
            }
            
            // Build options string
            let options = [];
            for (const [key, value] of Object.entries(xpathRules)) {
                if (value && !key.startsWith('_')) {
                    // Replace / with | and URL encode
                    const encoded = value.replace(/\//g, '|');
                    options.push(`${key}=${encodeURIComponent(encoded)}`);
                }
            }
            
            // Add mode=html
            options.push('mode=html');
            
            const morssBase = window.location.origin;
            const optionsStr = options.map(opt => {
                // For display, we need to properly format it
                return opt;
            }).join(':');
            
            const morssUrl = `${morssBase}/:${optionsStr}/${targetUrl}`;
            
            document.getElementById('morssUrl').textContent = morssUrl;
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                // Fallback method
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            });
        }
        
        function copyMorssUrl() {
            const url = document.getElementById('morssUrl').textContent;
            copyToClipboard(url);
        }
        
        function testInNewTab() {
            const url = document.getElementById('morssUrl').textContent;
            window.open(url, '_blank');
        }
        
        function closeIframe() {
            document.getElementById('iframeContainer').classList.add('hidden');
            document.getElementById('outputSection').classList.add('hidden');
            document.getElementById('selectionMode').classList.add('hidden');
            
            // Reset state
            xpathRules = {
                items: null,
                item_title: null,
                item_link: null,
                item_content: null,
                item_time: null
            };
            currentStepIndex = 0;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function escapeForJs(text) {
            return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }
        
        // Manual input mode
        function showManualInput() {
            const manualSection = document.getElementById('manualInputSection');
            manualSection.classList.toggle('hidden');
            
            // Close iframe if open
            if (!manualSection.classList.contains('hidden')) {
                document.getElementById('iframeContainer').classList.add('hidden');
                document.getElementById('selectionMode').classList.add('hidden');
            }
        }
        
        function closeManualInput() {
            const manualSection = document.getElementById('manualInputSection');
            manualSection.classList.add('hidden');
            
            // Clear inputs
            document.getElementById('manualItems').value = '';
            document.getElementById('manualTitle').value = '';
            document.getElementById('manualLink').value = '';
            document.getElementById('manualContent').value = '';
            document.getElementById('manualTime').value = '';
        }
        
        // XPath optimization function
        function optimizeXPath(xpath) {
            if (!xpath) return xpath;
            
            xpath = xpath.trim();
            
            // Remove leading/trailing quotes if present
            if ((xpath.startsWith('"') && xpath.endsWith('"')) || 
                (xpath.startsWith("'") && xpath.endsWith("'"))) {
                xpath = xpath.slice(1, -1);
            }
            
            // 1. Simplify complex absolute paths generated by browser
            // Example: /html/body/div[1]/div[2]/article[@class="post"]
            // Convert to: //article[@class="post"]
            
            // If xpath contains specific class/id at the end, try to simplify
            const classMatch = xpath.match(/\[@class=['"]([^'"]+)['"]\]$/);
            const idMatch = xpath.match(/\[@id=['"]([^'"]+)['"]\]$/);
            
            if (classMatch || idMatch) {
                // Extract the last element with class or id
                const parts = xpath.split('/');
                const lastPart = parts[parts.length - 1];
                const tagMatch = lastPart.match(/^(\w+)\[/);
                
                if (tagMatch) {
                    const tag = tagMatch[1];
                    if (classMatch) {
                        // Simplify to //tag[@class="..."]
                        xpath = `//${tag}[@class="${classMatch[1]}"]`;
                    } else if (idMatch) {
                        // Simplify to //*[@id="..."]
                        xpath = `//*[@id="${idMatch[1]}"]`;
                    }
                }
            }
            // If no class/id but has multiple levels, try to simplify by using //
            else if (xpath.startsWith('/html/body/') && !xpath.includes('[@')) {
                // Convert /html/body/div/div/article to //article
                const parts = xpath.split('/').filter(p => p);
                if (parts.length > 3) {
                    const lastTag = parts[parts.length - 1];
                    // Only simplify if the last tag looks specific (not just div)
                    if (lastTag !== 'div' && lastTag !== 'span') {
                        xpath = '//' + lastTag;
                    }
                }
            }
            
            // 2. Convert class exact match to Morss simplified syntax (only for items)
            // //div[@class="post"] can be written as //div[class=post] in Morss
            // But we'll keep the standard format for compatibility
            
            // 3. For relative paths (starting with .), ensure they are properly formatted
            if (xpath.startsWith('.//') || xpath.startsWith('./')) {
                // Already relative, keep as is
            } else if (xpath.startsWith('//') || xpath.startsWith('/')) {
                // Absolute path, keep as is
            } else if (!xpath.startsWith('/') && !xpath.startsWith('.')) {
                // No prefix, assume relative
                xpath = './' + xpath;
            }
            
            return xpath;
        }
        
        function generateFromManual() {
            // Get manual inputs
            let items = document.getElementById('manualItems').value.trim();
            
            if (!items) {
                alert('è¯·è‡³å°‘è¾“å…¥ items è§„åˆ™ï¼ˆå¿…éœ€ï¼‰');
                return;
            }
            
            targetUrl = document.getElementById('targetUrl').value.trim();
            if (!targetUrl) {
                alert('è¯·è¾“å…¥ç›®æ ‡ URL');
                return;
            }
            
            // Validate URL
            try {
                new URL(targetUrl);
            } catch (e) {
                alert('URL æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¾“å…¥å®Œæ•´çš„ URLï¼ˆåŒ…æ‹¬ http:// æˆ– https://ï¼‰');
                return;
            }
            
            // Optimize XPath expressions
            const originalItems = items;
            items = optimizeXPath(items);
            
            const title = document.getElementById('manualTitle').value.trim();
            const link = document.getElementById('manualLink').value.trim();
            const content = document.getElementById('manualContent').value.trim();
            const time = document.getElementById('manualTime').value.trim();
            
            xpathRules.items = items;
            xpathRules.item_title = optimizeXPath(title) || null;
            xpathRules.item_link = optimizeXPath(link) || null;
            xpathRules.item_content = optimizeXPath(content) || null;
            xpathRules.item_time = optimizeXPath(time) || null;
            
            // Store original for comparison
            xpathRules._original_items = originalItems !== items ? originalItems : null;
            
            // Close manual input and show results
            closeManualInput();
            displayResults();
        }
    </script>
</body>
</html>
